<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truco</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.0/socket.io.js" integrity="sha512-+l9L4lMTFNy3dEglQpprf7jQBhQsQ3/WvOnjaN/+/L4i0jOstgScV0q2TjfvRF4V+ZePMDuZYIQtg5T4MKr+MQ==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <section id = "log" style="display: flex; margin-top: 100px;">
        <form id="login">
            <input type="text" name="nick" placeholder="Digite seu nickname" required>
            
            <button type="submit">JOGAR</button>
        </form>
    </section>
    
    <section id = "game" style="display: none;">
        <div id="mesa">
            <div id="rival"></div>
            <div id="pontos" style="float: right;">
                <div id="ptRiv">Rival: <a>0</a> PTS</div>
                <div id="ptMeu">Eu: <a>0</a> PTS</div>
            </div>
            <div id="minha"></div>
        </div>

        <div id="mao">
            <ul>
                <li></li>
                <li></li>
                <li></li>
            </ul>
        </div>
        </br>
        <div id="truco"><a onclick="truco()">TRUCO</a></div>
    </section>
    
    <script>
        const socket = io(); // io vem da CDN

        // LOGIN
        $("#login").submit(function(e){
            e.preventDefault();
            let usu = $("input[name=nick]").val();
            socket.emit('username', usu);
        });
        socket.on("userOk", usu =>{             
            $("section:eq(0)").replaceWith($("section:eq(1)").fadeIn());
            socket.emit('newGame', usu);
        });
        socket.on("userNok", ()=>{
            alert("Nome de usuário indisponivel no momento.");
        });
        // Imprimir mão
        socket.on("cards", J =>{
            for(let x = 0; x<3; x++){
                let nipe = viraNipe(J.mao[x].nipe);
                let num = viraReal(J.mao[x].num);
                $(`li:eq(${x})`).html(`<a onclick="atk(${x})">${num} ${nipe}</a>`);
            }
        }); 
        // Jogar carta
        function atk(x) { socket.emit("cardAtk", x);}
        socket.on("AtkAtiv", c =>{
            if(c == null) return;
            else{
                if(($(`#minha`)).text() != ''){
                    $(`#rival`).html('');
                }
                $(`li:eq(${c[0]})`).html('');
                let nipe = viraNipe(c[1].nipe);
                let num = viraReal(c[1].num);
                $(`#minha`).html(`${num} ${nipe}`);
            }
        });
        socket.on("AtkPasv", c =>{
            if(($(`#rival`)).text() != ''){
                $(`#minha`).html('');
            }
            let nipe = viraNipe(c.nipe);
            let num = viraReal(c.num);
            $(`#rival`).html(`${num} ${nipe}`);
        }); 
        // Calcular vitória 
        socket.on("win", x =>{
            $(`#minha`).html('');
            $(`#rival`).html('');
            $(`#ptMeu a`).html(Number($(`#ptMeu a`).text())+x);
        });
        socket.on("los", x =>{
            $(`#minha`).html('');
            $(`#rival`).html('');
            $("#ptRiv a").html(Number($(`#ptRiv a`).text())+x);
        });
        socket.on("winGame", () =>{
            alert("PARABÉNS VOCÊ VENCEU !!!");
            location.reload(true);
        });
        socket.on("losGame", () =>{
            alert("Você perdeu, mais sorte na próxima !!!");
            location.reload(true);
        });
        // TRUCO -> Pedir / Aceitar
        function truco() {socket.emit("TrucoAtiv");}
        socket.on("TrucoPasv", ()=>{
            $("#truco").html(`SEU OPONENTE TRUCOU: <a onclick="aceitar()">ACEITAR</a> || <a onclick="correr()">CORRER</a>`)
        });
        function aceitar(){
            $("#truco").html(`<a onclick="truco()">TRUCO</a>`);
            socket.emit("Aceitar");
        };
        function correr(){
            $("#truco").html(`<a onclick="truco()">TRUCO</a>`);
            socket.emit("Correr");
        };
        // Oponente quitou
        socket.on("RivalOff", ()=>{
            alert("SEU OPONENTE DESCONECTOU DA PARTIDA!");
            location.reload(true);
            //$("section").load("./index.html");
        });
        
        //FUNÇÕES
        function viraNipe(n) {
            let nipe;
            switch (n) {
                case 1:
                    nipe = '♠';
                    break;
                case 2:
                    nipe = '❤';
                    break;
                case 3:
                    nipe = '♣';
                    break;
                case 4:
                    nipe = '♦';
                    break;
            }
            return nipe;
        }
        function viraReal(n) {
            let num;
            switch (n) {
                case 8:
                    num = 'Q';
                    break;
                case 9:
                    num = 'J';
                    break;
                case 10:
                    num = 'K';
                    break;
                case 1:
                    num = 'A';
                    break;
                default:
                    num = n
            }
            return num;
        }
    
    </script>
</body>
</html>